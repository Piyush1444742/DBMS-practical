-- Full unnamed PL/SQL block for returning a book and calculating fine
DECLARE
    v_roll_no      Borrower.Roll_no%TYPE;
    v_nameofbook   Borrower.NameofBook%TYPE;
    v_dateofissue  Borrower.DateofIssue%TYPE;
    v_status       Borrower.Status%TYPE;
    v_days         NUMBER;
    v_fine         NUMBER;
    e_not_found    EXCEPTION;   -- user-defined exception

BEGIN
    -- Accept input from user (replace with actual input in APEX)
    v_roll_no := &Enter_RollNo;
    v_nameofbook := '&Enter_BookName';

    -- Fetch borrower's details
    BEGIN
        SELECT DateofIssue, Status 
        INTO v_dateofissue, v_status
        FROM Borrower
        WHERE Roll_no = v_roll_no
          AND NameofBook = v_nameofbook;

        -- If status is null or book not issued, raise exception
        IF v_status IS NULL OR v_status = 'R' THEN
            RAISE e_not_found;
        END IF;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE e_not_found;
    END;

    -- Calculate days since book was issued
    v_days := TRUNC(SYSDATE - v_dateofissue);

    -- Initialize fine
    v_fine := 0;

    -- Calculate fine based on number of days
    IF v_days BETWEEN 15 AND 30 THEN
        v_fine := v_days * 5;       -- Rs 5 per day
    ELSIF v_days > 30 THEN
        v_fine := 30 * 5 + (v_days - 30) * 50;  -- Rs 5 for first 30 days, Rs 50 for extra
    END IF;

    -- Update Borrower status to Returned (R)
    UPDATE Borrower
    SET Status = 'R'
    WHERE Roll_no = v_roll_no
      AND NameofBook = v_nameofbook;

    -- Insert fine record if fine > 0
    IF v_fine > 0 THEN
        INSERT INTO Fine(Roll_no, Date, Amt)
        VALUES(v_roll_no, SYSDATE, v_fine);
    END IF;

    COMMIT;

    DBMS_OUTPUT.PUT_LINE('Book returned successfully.');
    DBMS_OUTPUT.PUT_LINE('Fine Amount: Rs ' || v_fine);

EXCEPTION
    WHEN e_not_found THEN
        DBMS_OUTPUT.PUT_LINE('Error: Borrower or Book not found, or already returned.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Unexpected error: ' || SQLERRM);
        ROLLBACK;
END;
/
